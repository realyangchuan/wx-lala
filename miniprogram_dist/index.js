"use strict";function n(n){return new Promise(((e,t)=>{setTimeout((()=>t(new Error("timeout"))),n)}))}function e(n){let e=null,t=null;function c(){n.p=e=t=null}n.p=null,Object.assign(n,{lock(){n.p=new Promise(((n,c)=>{e=n,t=c}))},unlock(){e&&(e?.(),c())},cancel(){t&&(t?.(new Error("canceled")),c())}})}function t(n,e){n?n.then((async()=>await(e?.()))):e?.()}function c(n){return"Object"===Object.prototype.toString.call(n).slice(8,-1)}function o(n,e,t=!0){const r={...n};for(const n in e){if(t&&"env"===n)continue;const s=e.baseURL;if(t&&"baseURL"===n&&s){const n=r.url;if(void 0===n||/^https?:\/\//.test(n))continue;const e=Array.prototype.findIndex.call(n,(n=>/\w/.test(n))),t=-1===e?"":n.slice(e);s.endsWith("/")?r.url=s+t:r.url=t?s+"/"+t:s}else r.hasOwnProperty(n)?c(r[n])&&c(e[n])&&(r[n]=o(r[n],e[n],!1)):r[n]=e[n]}return r}function r(n,c){function r(e){const s=r.interceptors;return new Promise(((r,i)=>{t(s.request.p,(async()=>{const u=o(e,n),l=await Promise.resolve(s.request.handler?.(u))??u;c(l).then((n=>{t(s.response.p,(async()=>{const e=await Promise.resolve(s.response.handler?.(n,l))??n;r(e)}))})).catch((n=>{t(s.response.p,(async()=>{const e=await Promise.resolve(s.response.errHandler?.(n,l))??n;i(e)}))}))}))}))}return r.interceptors=function(){const n={request:{use(n){this.handler=n}},response:{use(n,e){this.handler=n,this.errHandler=e}}};return e(n.request),e(n.response),n}(),r}function s(n,e){return new Promise(((t,c)=>{n({...e,async success(n){t(await(e.success?.(n))??n)},async fail(n){c(await(e.fail?.(n))??n)},async complete(){await(e.complete?.())}})}))}function i(n){return s(wx.request,n)}module.exports=function(e={}){const t=function(n){n.env&&wx.cloud.init({env:n.env});let e=wx.cloud;n.function?.env&&(e=new wx.cloud.Cloud({resourceEnv:n.function.env}),e.init());let t=wx.cloud;return n.container?.env&&(t=new wx.cloud.Cloud({resourceEnv:n.container.env}),t.init()),{cloudFunctionInstance:e,cloudContainerInstance:t}}(e);return{request:r(e?.request??{},i),callFunction:r(e?.function??{},(e=>function(e,t){const{timeout:c,...o}=e;let r=null;return r=o.success||o.fail||o.complete?s(t.callFunction,o):t.callFunction(o),c?Promise.race([r,n(c)]):r}(e,t.cloudFunctionInstance))),callContainer:r(e?.container??{},(n=>function(n,e){const{success:t,fail:c,complete:o}=n;return t||c||o?s(e.callContainer,n):e.callContainer(n)}(n,t.cloudContainerInstance)))}};
